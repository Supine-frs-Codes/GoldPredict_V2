#!/usr/bin/env python3
"""
ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªü
Âü∫‰∫éÂéüÂßãweb_interface.pyÁöÑÁÆÄÂåñÁâàÊú¨Ôºå‰øùÊåÅÂéüÊúâÂäüËÉΩÂíåÁïåÈù¢
"""

from flask import Flask, render_template_string, jsonify, request, send_file
import subprocess
import threading
import json
import os
import time
from datetime import datetime
from pathlib import Path
import logging

logger = logging.getLogger(__name__)


class SimpleTaskRunner:
    """ÁÆÄÂçï‰ªªÂä°ÊâßË°åÂô®"""
    
    def __init__(self):
        self.base_dir = Path(".")
        self.results_dir = Path("results")
        self.task_status = {}
        self.task_results = {}
        
    def run_command(self, command, task_id, description):
        """ËøêË°åÂëΩ‰ª§"""
        try:
            self.task_status[task_id] = 'running'
            self.task_results[task_id] = {
                'description': description,
                'start_time': datetime.now().isoformat(),
                'status': 'running',
                'output': []
            }
            
            # ÊâßË°åÂëΩ‰ª§
            process = subprocess.Popen(
                command,
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                cwd=self.base_dir
            )
            
            # ËØªÂèñËæìÂá∫
            output_lines = []
            for line in iter(process.stdout.readline, ''):
                if line:
                    output_lines.append(line.strip())
                    self.task_results[task_id]['output'].append(line.strip())
            
            process.wait()
            
            # Êõ¥Êñ∞Áä∂ÊÄÅ
            if process.returncode == 0:
                self.task_status[task_id] = 'completed'
                self.task_results[task_id]['status'] = 'completed'
            else:
                self.task_status[task_id] = 'failed'
                self.task_results[task_id]['status'] = 'failed'
                
            self.task_results[task_id]['end_time'] = datetime.now().isoformat()
            self.task_results[task_id]['return_code'] = process.returncode
            
        except Exception as e:
            self.task_status[task_id] = 'failed'
            self.task_results[task_id]['status'] = 'failed'
            self.task_results[task_id]['error'] = str(e)
    
    def get_task_status(self, task_id):
        """Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅ"""
        return {
            'status': self.task_status.get(task_id, 'unknown'),
            'result': self.task_results.get(task_id, {})
        }


class SimplePredictionSystem:
    """ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªü"""
    
    def __init__(self):
        self.task_runner = SimpleTaskRunner()
        self.is_running = False
        
        print(f"[ÁÆÄÂçïÈ¢ÑÊµã] ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÂàùÂßãÂåñÂÆåÊàê")
    
    def start(self) -> bool:
        """ÂêØÂä®Á≥ªÁªüÔºàÁªü‰∏ÄÊé•Âè£Ôºâ"""
        return self.start_system()

    def start_system(self) -> bool:
        """ÂêØÂä®Á≥ªÁªü"""
        try:
            self.is_running = True
            print(f"[ÁÆÄÂçïÈ¢ÑÊµã] Á≥ªÁªüÂêØÂä®ÊàêÂäü")
            return True
        except Exception as e:
            logger.error(f"ÂêØÂä®ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÂ§±Ë¥•: {e}")
            return False
    
    def stop_system(self) -> bool:
        """ÂÅúÊ≠¢Á≥ªÁªü"""
        try:
            self.is_running = False
            print(f"[ÁÆÄÂçïÈ¢ÑÊµã] Á≥ªÁªüÂÅúÊ≠¢ÊàêÂäü")
            return True
        except Exception as e:
            logger.error(f"ÂÅúÊ≠¢ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÂ§±Ë¥•: {e}")
            return False
    
    def get_status(self) -> dict:
        """Ëé∑ÂèñÁ≥ªÁªüÁä∂ÊÄÅ"""
        try:
            # Ê£ÄÊü•Êï∞ÊçÆÊñá‰ª∂
            data_files = list(Path("results/data").glob("*.csv")) if Path("results/data").exists() else []
            model_files = list(Path("results/models").glob("**/*.pth")) if Path("results/models").exists() else []
            
            return {
                'running': self.is_running,
                'data_files': len(data_files),
                'model_files': len(model_files),
                'timestamp': datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"Ëé∑ÂèñÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•: {e}")
            return {'running': False, 'error': str(e)}
    
    def run_task(self, task_type: str, config: dict = None) -> dict:
        """ËøêË°å‰ªªÂä°"""
        try:
            task_id = f"{task_type}_{int(time.time())}"
            
            # ÂÆö‰πâ‰ªªÂä°ÂëΩ‰ª§
            commands = {
                'gpu_test': {
                    'command': 'uv run python test_gpu.py',
                    'description': 'GPUÂÖºÂÆπÊÄßÊµãËØï'
                },
                'data_collection': {
                    'command': 'uv run python web_data_collect.py',
                    'description': 'Êï∞ÊçÆÊî∂ÈõÜ'
                },
                'quick_demo': {
                    'command': 'uv run python demo_prediction.py',
                    'description': 'Âø´ÈÄüÈ¢ÑÊµãÊºîÁ§∫'
                },
                'simple_prediction': {
                    'command': 'uv run python web_predict.py --mode simple',
                    'description': 'ÁÆÄÂçïÈ¢ÑÊµã'
                },
                'multiple_prediction': {
                    'command': 'uv run python web_predict.py --mode multiple',
                    'description': 'Â§öÊ®°ÂûãÈ¢ÑÊµã'
                },
                'uncertainty_prediction': {
                    'command': 'uv run python web_predict.py --mode uncertainty',
                    'description': '‰∏çÁ°ÆÂÆöÊÄßÈ¢ÑÊµã'
                },
                'organize_files': {
                    'command': 'uv run python organize_results.py',
                    'description': 'Êï¥ÁêÜÁªìÊûúÊñá‰ª∂'
                }
            }
            
            if task_type not in commands:
                return {'success': False, 'message': f'Êú™Áü•‰ªªÂä°Á±ªÂûã: {task_type}'}
            
            command_info = commands[task_type]
            
            # Âú®ÂêéÂè∞ËøêË°å‰ªªÂä°
            thread = threading.Thread(
                target=self.task_runner.run_command,
                args=(command_info['command'], task_id, command_info['description'])
            )
            thread.daemon = True
            thread.start()
            
            return {
                'success': True,
                'task_id': task_id,
                'description': command_info['description']
            }
            
        except Exception as e:
            logger.error(f"ËøêË°å‰ªªÂä°Â§±Ë¥•: {e}")
            return {'success': False, 'message': str(e)}
    
    def get_task_status(self, task_id: str) -> dict:
        """Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅ"""
        return self.task_runner.get_task_status(task_id)


# ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÁöÑHTMLÊ®°Êùø
SIMPLE_PREDICTION_TEMPLATE = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•á ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªü - Êìç‰ΩúÁïåÈù¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        .status-panel {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .status-item {
            text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .panel {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .panel h2 {
            color: #333; margin-bottom: 20px; font-size: 1.5em;
            border-bottom: 2px solid #007bff; padding-bottom: 10px;
        }
        
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .action-btn {
            padding: 15px 20px; border: none; border-radius: 10px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .btn-primary { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
        .btn-success { background: linear-gradient(45deg, #28a745, #1e7e34); color: white; }
        .btn-warning { background: linear-gradient(45deg, #ffc107, #e0a800); color: #212529; }
        .btn-info { background: linear-gradient(45deg, #17a2b8, #138496); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #6c757d, #545b62); color: white; }
        
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .log-panel {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .log-container {
            background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 10px;
            height: 400px; overflow-y: auto; font-family: 'Courier New', monospace;
            font-size: 14px; line-height: 1.4;
        }
        .log-entry { margin-bottom: 5px; }
        .log-timestamp { color: #888; }
        .log-success { color: #00ff00; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ffaa00; }
        
        .back-btn {
            position: fixed; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 25px;
            text-decoration: none; color: white; font-weight: bold;
        }
        .back-btn:hover { background: rgba(0,0,0,0.7); }
        
        @media (max-width: 768px) {
            .control-panel { grid-template-columns: 1fr; }
            .button-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
    
    <div class="container">
        <div class="header">
            <h1>ü•á ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªü</h1>
            <p>ÂéüÂßãÂäüËÉΩÂÆåÊï¥‰øùÁïô - ‰∏∞ÂØåÊìç‰ΩúÊåâÈíÆÂíåÊñá‰ª∂ÁÆ°ÁêÜ</p>
        </div>
        
        <!-- Á≥ªÁªüÁä∂ÊÄÅÈù¢Êùø -->
        <div class="status-panel">
            <h2>üìä Á≥ªÁªüÁä∂ÊÄÅ</h2>
            <div class="status-grid">
                <div class="status-item">
                    <h3>Á≥ªÁªüÁä∂ÊÄÅ</h3>
                    <p id="system-status">Êú™Áü•</p>
                </div>
                <div class="status-item">
                    <h3>Êï∞ÊçÆÊñá‰ª∂</h3>
                    <p id="data-files">0</p>
                </div>
                <div class="status-item">
                    <h3>Ê®°ÂûãÊñá‰ª∂</h3>
                    <p id="model-files">0</p>
                </div>
                <div class="status-item">
                    <h3>ÊúÄÂêéÊõ¥Êñ∞</h3>
                    <p id="last-update">--</p>
                </div>
            </div>
        </div>
        
        <!-- ÊéßÂà∂Èù¢Êùø -->
        <div class="control-panel">
            <!-- Êï∞ÊçÆÂíåÊµãËØïÊìç‰Ωú -->
            <div class="panel">
                <h2>üîß Êï∞ÊçÆÂíåÊµãËØïÊìç‰Ωú</h2>
                <div class="button-grid">
                    <button class="action-btn btn-info" onclick="runTask('gpu_test')">
                        üñ•Ô∏è GPUÂÖºÂÆπÊÄßÊµãËØï
                    </button>
                    <button class="action-btn btn-primary" onclick="runTask('data_collection')">
                        üìä Êï∞ÊçÆÊî∂ÈõÜ
                    </button>
                    <button class="action-btn btn-success" onclick="runTask('quick_demo')">
                        ‚ö° Âø´ÈÄüÈ¢ÑÊµãÊºîÁ§∫
                    </button>
                    <button class="action-btn btn-secondary" onclick="runTask('organize_files')">
                        üìÅ Êï¥ÁêÜÁªìÊûúÊñá‰ª∂
                    </button>
                </div>
            </div>
            
            <!-- È¢ÑÊµãÊìç‰Ωú -->
            <div class="panel">
                <h2>üîÆ È¢ÑÊµãÊìç‰Ωú</h2>
                <div class="button-grid">
                    <button class="action-btn btn-primary" onclick="runTask('simple_prediction')">
                        üéØ ÁÆÄÂçïÈ¢ÑÊµã
                    </button>
                    <button class="action-btn btn-warning" onclick="runTask('multiple_prediction')">
                        üîÑ Â§öÊ®°ÂûãÈ¢ÑÊµã
                    </button>
                    <button class="action-btn btn-info" onclick="runTask('uncertainty_prediction')">
                        üìà ‰∏çÁ°ÆÂÆöÊÄßÈ¢ÑÊµã
                    </button>
                    <button class="action-btn btn-success" onclick="refreshStatus()">
                        üîÑ Âà∑Êñ∞Áä∂ÊÄÅ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Êó•ÂøóÈù¢Êùø -->
        <div class="log-panel">
            <h2>üìù Êìç‰ΩúÊó•Âøó</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry log-success">
                    <span class="log-timestamp">[Á≠âÂæÖ]</span> ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÂáÜÂ§áÂ∞±Áª™
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentTasks = new Set();
        
        function runTask(taskType) {
            if (currentTasks.has(taskType)) {
                addLog('‰ªªÂä°Ê≠£Âú®ËøêË°å‰∏≠...', 'warning');
                return;
            }
            
            addLog(`ÂêØÂä®‰ªªÂä°: ${taskType}`, 'info');
            currentTasks.add(taskType);
            
            fetch('/api/simple/run_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task_type: taskType})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`‰ªªÂä°ÂêØÂä®ÊàêÂäü: ${data.description}`, 'success');
                    monitorTask(data.task_id, taskType);
                } else {
                    addLog(`‰ªªÂä°ÂêØÂä®Â§±Ë¥•: ${data.message}`, 'error');
                    currentTasks.delete(taskType);
                }
            })
            .catch(error => {
                addLog(`ËØ∑Ê±ÇÂ§±Ë¥•: ${error}`, 'error');
                currentTasks.delete(taskType);
            });
        }
        
        function monitorTask(taskId, taskType) {
            const checkStatus = () => {
                fetch(`/api/simple/task_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const status = data.status;
                    const result = data.result;
                    
                    if (status === 'running') {
                        setTimeout(checkStatus, 2000);
                    } else {
                        currentTasks.delete(taskType);
                        if (status === 'completed') {
                            addLog(`‰ªªÂä°ÂÆåÊàê: ${taskType}`, 'success');
                        } else {
                            addLog(`‰ªªÂä°Â§±Ë¥•: ${taskType}`, 'error');
                        }
                        refreshStatus();
                    }
                })
                .catch(error => {
                    currentTasks.delete(taskType);
                    addLog(`ÁõëÊéß‰ªªÂä°Â§±Ë¥•: ${error}`, 'error');
                });
            };
            
            setTimeout(checkStatus, 1000);
        }
        
        function refreshStatus() {
            fetch('/api/simple/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('system-status').textContent = data.running ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢';
                document.getElementById('data-files').textContent = data.data_files || 0;
                document.getElementById('model-files').textContent = data.model_files || 0;
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                addLog('Áä∂ÊÄÅÂ∑≤Âà∑Êñ∞', 'info');
            })
            .catch(error => {
                addLog(`Áä∂ÊÄÅÂà∑Êñ∞Â§±Ë¥•: ${error}`, 'error');
            });
        }
        
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ‰øùÊåÅÊúÄËøë100Êù°Êó•Âøó
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // ÂàùÂßãÂåñ
        addLog('ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÁïåÈù¢Âä†ËΩΩÂÆåÊàê', 'success');
        refreshStatus();
        
        // ÂÆöÊúüÂà∑Êñ∞Áä∂ÊÄÅ
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
'''


def main():
    """ÊµãËØïÂáΩÊï∞"""
    print("ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÊµãËØï")
    print("=" * 40)
    
    system = SimplePredictionSystem()
    
    # ÊµãËØïÂêØÂä®
    if system.start_system():
        print("‚úÖ Á≥ªÁªüÂêØÂä®ÊàêÂäü")
        
        # ÊµãËØïÁä∂ÊÄÅ
        status = system.get_status()
        print(f"üìä Á≥ªÁªüÁä∂ÊÄÅ: {status}")
        
        # ÊµãËØï‰ªªÂä°
        result = system.run_task('gpu_test')
        print(f"üîß ‰ªªÂä°ÁªìÊûú: {result}")
        
        print("‚úÖ ÁÆÄÂçïÈ¢ÑÊµãÁ≥ªÁªüÊµãËØïÂÆåÊàê!")
    else:
        print("‚ùå Á≥ªÁªüÂêØÂä®Â§±Ë¥•")


if __name__ == "__main__":
    main()
